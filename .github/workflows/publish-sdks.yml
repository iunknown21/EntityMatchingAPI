name: Publish SDKs

on:
  workflow_dispatch:
    inputs:
      publish_npm:
        description: 'Publish JavaScript SDK to npm'
        required: true
        type: boolean
        default: true
      publish_nuget:
        description: 'Publish C# SDK to NuGet'
        required: true
        type: boolean
        default: true
      version:
        description: 'Version to publish (e.g., 1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Is this a prerelease?'
        required: true
        type: boolean
        default: false

env:
  DOTNET_VERSION: '8.0.x'
  NODE_VERSION: '20.x'

jobs:
  publish-javascript-sdk:
    if: ${{ inputs.publish_npm }}
    runs-on: ubuntu-latest

    steps:
    - name: 'Checkout code'
      uses: actions/checkout@v4

    - name: Setup Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        registry-url: 'https://registry.npmjs.org'

    - name: 'Update package version'
      working-directory: ./EntityMatching.SDK.JS
      run: |
        npm version ${{ inputs.version }} --no-git-tag-version
        if [ "${{ inputs.prerelease }}" == "true" ]; then
          npm version prerelease --no-git-tag-version
        fi

    - name: 'Install dependencies'
      working-directory: ./EntityMatching.SDK.JS
      run: npm install

    - name: 'Build TypeScript'
      working-directory: ./EntityMatching.SDK.JS
      run: npm run build

    - name: 'Run tests'
      working-directory: ./EntityMatching.SDK.JS
      run: npm test || echo "No tests configured yet"

    - name: 'Publish to npm'
      working-directory: ./EntityMatching.SDK.JS
      run: |
        if [ "${{ inputs.prerelease }}" == "true" ]; then
          npm publish --tag beta --access public
        else
          npm publish --access public
        fi
      env:
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

    - name: 'Summary'
      run: |
        echo "âœ… JavaScript SDK v${{ inputs.version }} published to npm" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“¦ Package: @entitymatching/sdk" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— https://www.npmjs.com/package/@entitymatching/sdk" >> $GITHUB_STEP_SUMMARY

  publish-csharp-sdk:
    if: ${{ inputs.publish_nuget }}
    runs-on: ubuntu-latest

    steps:
    - name: 'Checkout code'
      uses: actions/checkout@v4

    - name: Setup .NET ${{ env.DOTNET_VERSION }}
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: 'Restore dependencies'
      run: dotnet restore EntityMatching.SDK/EntityMatching.SDK.csproj

    - name: 'Build SDK'
      run: |
        dotnet build EntityMatching.SDK/EntityMatching.SDK.csproj \
          --configuration Release \
          --no-restore \
          /p:Version=${{ inputs.version }}

    - name: 'Run tests'
      run: |
        dotnet test EntityMatching.Tests/EntityMatching.Tests.csproj \
          --configuration Release \
          --no-build \
          --filter "Category=SDK"

    - name: 'Pack NuGet package'
      run: |
        dotnet pack EntityMatching.SDK/EntityMatching.SDK.csproj \
          --configuration Release \
          --no-build \
          --output ./nupkgs \
          /p:PackageVersion=${{ inputs.version }} \
          /p:IncludeSymbols=true \
          /p:SymbolPackageFormat=snupkg

    - name: 'Publish to NuGet'
      run: |
        dotnet nuget push ./nupkgs/*.nupkg \
          --api-key ${{ secrets.NUGET_API_KEY }} \
          --source https://api.nuget.org/v3/index.json \
          --skip-duplicate

    - name: 'Summary'
      run: |
        echo "âœ… C# SDK v${{ inputs.version }} published to NuGet" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“¦ Package: EntityMatching.SDK" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ”— https://www.nuget.org/packages/EntityMatching.SDK" >> $GITHUB_STEP_SUMMARY

  create-github-release:
    needs: [publish-javascript-sdk, publish-csharp-sdk]
    if: always() && !failure()
    runs-on: ubuntu-latest

    steps:
    - name: 'Checkout code'
      uses: actions/checkout@v4

    - name: 'Create GitHub Release'
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ inputs.version }}
        release_name: SDK Release v${{ inputs.version }}
        body: |
          ## SDK Release v${{ inputs.version }}

          ### Published Packages:
          - ðŸ“¦ **JavaScript SDK**: [@entitymatching/sdk](https://www.npmjs.com/package/@entitymatching/sdk)
          - ðŸ“¦ **C# SDK**: [EntityMatching.SDK](https://www.nuget.org/packages/EntityMatching.SDK)

          ### Installation:

          **JavaScript/TypeScript:**
          ```bash
          npm install @entitymatching/sdk@${{ inputs.version }}
          ```

          **C#/.NET:**
          ```bash
          dotnet add package EntityMatching.SDK --version ${{ inputs.version }}
          ```

          ### Documentation:
          - [JavaScript SDK Documentation](https://github.com/iunknown21/EntityMatchingAPI/tree/master/EntityMatching.SDK.JS)
          - [C# SDK Documentation](https://github.com/iunknown21/EntityMatchingAPI/tree/master/EntityMatching.SDK)
        draft: false
        prerelease: ${{ inputs.prerelease }}
