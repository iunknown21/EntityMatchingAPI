name: Deploy PrivateMatch Demo

on:
  # Disabled automatic deployment - manually trigger when ready
  # push:
  #   branches: [ master, main ]
  #   paths:
  #     - 'PrivateMatch.Demo/**'
  #     - 'ProfileMatching.SDK/**'
  #     - '.github/workflows/deploy-demo.yml'
  workflow_dispatch:  # Manual trigger only

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    name: Build and Deploy PrivateMatch Demo

    steps:
    - name: 'Checkout code'
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: Setup .NET ${{ env.DOTNET_VERSION }}
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: 'Install .NET WASM tools'
      run: dotnet workload install wasm-tools

    - name: 'Restore dependencies'
      run: dotnet restore PrivateMatch.Demo/PrivateMatch.Demo.csproj

    - name: 'Build Blazor WebAssembly app'
      run: |
        dotnet build PrivateMatch.Demo/PrivateMatch.Demo.csproj \
          --configuration Release \
          --no-restore

    - name: 'Publish Blazor app'
      run: |
        dotnet publish PrivateMatch.Demo/PrivateMatch.Demo.csproj \
          --configuration Release \
          --output ./publish \
          --no-build

    - name: 'Deploy to Azure Static Web Apps'
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ secrets.AZURE_STATIC_WEB_APPS_API_TOKEN }}
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        action: 'upload'
        app_location: './publish/wwwroot'
        api_location: ''
        output_location: ''
        skip_app_build: true

    - name: 'Deployment summary'
      run: |
        echo "### âœ… PrivateMatch Demo Deployed" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŒ **Live Demo**: Check Azure Portal for Static Web App URL" >> $GITHUB_STEP_SUMMARY
        echo "ðŸ“± **Features**:" >> $GITHUB_STEP_SUMMARY
        echo "  - Privacy-first resume upload demo" >> $GITHUB_STEP_SUMMARY
        echo "  - Semantic profile search" >> $GITHUB_STEP_SUMMARY
        echo "  - Cost and security comparison" >> $GITHUB_STEP_SUMMARY
        echo "  - Interactive data breach simulation" >> $GITHUB_STEP_SUMMARY
