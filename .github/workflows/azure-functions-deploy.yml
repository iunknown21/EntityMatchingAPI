name: Deploy EntityMatching API to Azure Functions

on:
  push:
    branches: [ master, main ]
    paths:
      - 'EntityMatching.Functions/**'
      - 'EntityMatching.Core/**'
      - 'EntityMatching.Infrastructure/**'
      - 'EntityMatching.Shared/**'
      - '.github/workflows/azure-functions-deploy.yml'
  workflow_dispatch:

env:
  AZURE_FUNCTIONAPP_NAME: 'entityaiapi'
  AZURE_FUNCTIONAPP_PACKAGE_PATH: './EntityMatching.Functions'
  DOTNET_VERSION: '8.0.x'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: 'Checkout GitHub Action'
      uses: actions/checkout@v4

    - name: Setup .NET ${{ env.DOTNET_VERSION }}
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: 'Restore dependencies'
      run: dotnet restore

    - name: 'Build solution'
      run: dotnet build --configuration Release --no-restore

    - name: 'Run unit tests'
      timeout-minutes: 5  # Kill if tests hang
      run: |
        dotnet test EntityMatching.Tests/EntityMatching.Tests.csproj \
          --filter "FullyQualifiedName!~Integration&FullyQualifiedName!~Demo" \
          --configuration Release \
          --no-build \
          --verbosity normal \
          --logger "console;verbosity=detailed" \
          --collect:"XPlat Code Coverage"
      continue-on-error: false  # Block deployment if unit tests fail (skips all Integration/Demo tests)

    - name: 'Publish Functions'
      run: |
        dotnet publish ${{ env.AZURE_FUNCTIONAPP_PACKAGE_PATH }}/EntityMatching.Functions.csproj \
          --configuration Release \
          --output ./output

    - name: 'Create deployment package'
      run: |
        cd ./output
        zip -r ../output.zip .
        cd ..

    - name: 'Azure Login'
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: 'Deploy to Azure Functions'
      run: |
        az functionapp deployment source config-zip \
          --resource-group entitymatchingai \
          --name ${{ env.AZURE_FUNCTIONAPP_NAME }} \
          --src ./output.zip
      env:
        AZURE_FUNCTIONAPP_PACKAGE: './output'

    - name: 'Verify deployment'
      run: |
        echo "Waiting for Functions to warm up..."
        sleep 30
        echo "Testing if Functions app is responding..."
        curl -f https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net/api/version
        echo ""
        echo "‚úÖ Deployment verified - API is responding"

    - name: 'Deployment summary'
      run: |
        echo "‚úÖ Azure Functions deployed successfully to ${{ env.AZURE_FUNCTIONAPP_NAME }}"
        echo "üåê Endpoint: https://${{ env.AZURE_FUNCTIONAPP_NAME }}.azurewebsites.net"
        echo "üîó APIM Gateway: https://entitymatching-apim.azure-api.net/v1"
